<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Caprock — Bidding App (Seller)</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f3f2ef; /* dusty cotton */
  --accent:#6b0f18; /* dark royal red */
  --navy:#041029; /* dark navy */
  --card:#ffffff;
  --muted:#7b7b7b;
  --glass: rgba(255,255,255,0.7);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--navy);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;gap:16px}
.logo{width:64px;height:64px;border-radius:8px;background:linear-gradient(135deg,var(--navy),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-family:Playfair Display, serif}
.h1{font-family:Playfair Display, serif;font-size:24px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(4,16,41,0.06);margin-top:18px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.input,textarea,select{padding:10px;border-radius:8px;border:1px solid #e4e4e4;width:100%;font-size:14px}
textarea{min-height:84px;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 6px 14px rgba(107,15,24,0.18)}
.btn-ghost{background:transparent;border:1px solid #ddd;color:var(--navy)}
.btn-big{padding:12px 18px;font-size:15px;border-radius:12px}
.tooltip{position:relative}
.tooltip .hint{visibility:hidden;opacity:0;transition:all .15s;position:absolute;background:#041029;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;white-space:nowrap;transform:translateY(-6px);top:-10px;left:50%;transform:translateX(-50%) translateY(-6px)}
.tooltip:hover .hint{visibility:visible;opacity:1;transform:translateX(-50%) translateY(0)}
.lot-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px;margin-top:16px}
.lot-card{background:linear-gradient(180deg,#fff,var(--glass));border-radius:10px;padding:8px;border:1px solid #eee;display:flex;flex-direction:column;gap:8px}
.lot-photo{width:100%;height:150px;border-radius:8px;object-fit:cover;background:#fafafa;border:1px solid #f1f1f1}
.meta{font-size:13px;color:var(--muted)}
.top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.sale-dates{font-size:13px;color:var(--muted);margin-top:8px}
.notice{background:#fff5f5;border-left:4px solid var(--accent);padding:10px;border-radius:8px;margin:12px 0;color:#6b0f18}
.preview-url{font-family:monospace;background:#f7f7f7;padding:6px 8px;border-radius:6px;font-size:13px;display:inline-block}
.file-input{display:flex;gap:8px;align-items:center}
.hr{height:1px;background:#eee;margin:12px 0;border-radius:4px}
.small-muted{font-size:12px;color:#9a9a9a}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">CLX</div>
    <div>
      <div class="h1">Caprock Livestock Exchange — Bidding App</div>
      <div class="small">Seller entry & sale builder</div>
    </div>
  </div>

  <div id="entryCard" class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong>Protected Entry</strong>
        <div class="small-muted">Enter your seller entry number to open your sale builder.</div>
      </div>
      <div>
        <input id="entryCodeInput" class="input" placeholder="Enter entry number (e.g. 84921)" style="width:220px;display:inline-block" />
        <button id="entryCheckBtn" class="btn btn-primary">Enter</button>
      </div>
    </div>
    <div id="entryMsg" class="small" style="margin-top:10px"></div>
  </div>

  <div id="builder" style="display:none">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:700;font-size:18px">Create / Edit Sale</div>
          <div class="small-muted">Design a beautiful sale. Preview and then share the live link when ready.</div>
        </div>
        <div class="controls top-actions">
          <div class="tooltip">
            <button id="shareBtn" class="btn btn-primary btn-big">Share Live Bidding Site</button>
            <div class="hint">Copies link and shows it</div>
          </div>
          <div class="tooltip"><button id="startBtn" class="btn btn-ghost">Start Sale</button><div class="hint">Open sale to live bidders</div></div>
          <div class="tooltip"><button id="pauseBtn" class="btn btn-ghost">Temporarily Pause Sale</button><div class="hint">Pause bids until restarted</div></div>
          <div class="tooltip"><button id="endBtn" class="btn btn-ghost">End Sale</button><div class="hint">Close the sale</div></div>
          <div class="tooltip"><button id="exportAllBtn" class="btn btn-ghost">Export All Bids</button><div class="hint">CSV of all bids</div></div>
          <div class="tooltip"><button id="exportWinningBtn" class="btn btn-ghost">Export Winning Bids</button><div class="hint">CSV of winners</div></div>
        </div>
      </div>

      <div class="notice">
        The sale will automatically begin and end at your selected date and times. <span id="datesSummary"></span>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <div class="form-grid">
            <div>
              <label class="small">Business Name</label>
              <input id="businessName" class="input" placeholder="Your ranch or business name" />
            </div>
            <div>
              <label class="small">Sale Name</label>
              <input id="saleName" class="input" placeholder="Spring Bull Sale 2026" />
            </div>
            <div>
              <label class="small">Upload Logo (optional)</label>
              <input id="logoFile" type="file" accept="image/*" class="input" />
            </div>
            <div>
              <label class="small">Short Description (optional)</label>
              <input id="saleDesc" class="input" placeholder="A short description visible on the live board" />
            </div>

            <div>
              <label class="small">Number of Lots</label>
              <input id="numLots" type="number" min="1" max="200" class="input" value="4" />
            </div>

            <div>
              <label class="small">Use same opening price & increment for all lots?</label>
              <select id="globalBidToggle" class="input">
                <option value="yes">Yes - same for all</option>
                <option value="no">No - set per lot</option>
              </select>
            </div>

            <div>
              <label class="small">If yes: Opening Price ($)</label>
              <input id="globalStart" type="number" min="0" class="input" value="100" />
            </div>
            <div>
              <label class="small">If yes: Bid Increment ($)</label>
              <input id="globalIncrement" type="number" min="1" class="input" value="50" />
            </div>

            <div>
              <label class="small">Sale Start (local datetime)</label>
              <input id="startDT" type="datetime-local" class="input" />
            </div>
            <div>
              <label class="small">Sale End (local datetime)</label>
              <input id="endDT" type="datetime-local" class="input" />
            </div>
            <div style="grid-column:span 2">
              <label class="small">Time Zone</label>
              <select id="tzSelect" class="input">
                <!-- Minimal list; expand as needed -->
                <option value="America/Chicago">America/Chicago (Central)</option>
                <option value="America/Denver">America/Denver (Mountain)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (Pacific)</option>
                <option value="America/New_York">America/New_York (Eastern)</option>
                <option value="UTC">UTC</option>
              </select>
            </div>

          </div>

          <div style="margin-top:12px">
            <button id="createSaleBtn" class="btn btn-primary">Create Sale & Add Lots</button>
            <button id="saveSaleBtn" class="btn btn-ghost">Save Changes</button>
          </div>
        </div>

        <div style="flex:1;min-width:320px">
          <div class="small-muted">Preview & link</div>
          <div class="card" id="previewCard">
            <div style="display:flex;gap:12px;align-items:center">
              <img id="previewLogo" src="" alt="" style="width:72px;height:72px;border-radius:8px;object-fit:cover;display:none" />
              <div>
                <div id="previewTitle" style="font-weight:700">—</div>
                <div id="previewSub" class="small-muted">—</div>
                <div style="margin-top:8px"><span class="small-muted">Live URL:</span> <span id="liveUrl" class="preview-url">not published</span></div>
              </div>
            </div>

            <div class="hr"></div>
            <div id="lotsContainer">
              <div class="small-muted">No lots yet</div>
            </div>
          </div>

        </div>
      </div>

      <div id="lotsBuilder" style="margin-top:16px"></div>
    </div>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCquC_ZsPf59yGnlFLzK8Du1mgibvKOK_M",
  authDomain: "biddingapp-a6d8e.firebaseapp.com",
  projectId: "biddingapp-a6d8e",
  storageBucket: "biddingapp-a6d8e.firebasestorage.app",
  messagingSenderId: "870014358891",
  appId: "1:870014358891:web:b74cf577dfd38eff46e82e",
  measurementId: "G-0QWG9DQCLG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ---------- UI references ---------- */
const entryCard = document.getElementById('entryCard');
const entryCodeInput = document.getElementById('entryCodeInput');
const entryCheckBtn = document.getElementById('entryCheckBtn');
const entryMsg = document.getElementById('entryMsg');
const builder = document.getElementById('builder');

const businessName = document.getElementById('businessName');
const saleName = document.getElementById('saleName');
const logoFile = document.getElementById('logoFile');
const saleDesc = document.getElementById('saleDesc');
const numLots = document.getElementById('numLots');
const globalBidToggle = document.getElementById('globalBidToggle');
const globalStart = document.getElementById('globalStart');
const globalIncrement = document.getElementById('globalIncrement');
const startDT = document.getElementById('startDT');
const endDT = document.getElementById('endDT');
const tzSelect = document.getElementById('tzSelect');

const createSaleBtn = document.getElementById('createSaleBtn');
const saveSaleBtn = document.getElementById('saveSaleBtn');
const previewTitle = document.getElementById('previewTitle');
const previewSub = document.getElementById('previewSub');
const previewLogo = document.getElementById('previewLogo');
const liveUrl = document.getElementById('liveUrl');
const lotsContainer = document.getElementById('lotsContainer');
const lotsBuilder = document.getElementById('lotsBuilder');

const shareBtn = document.getElementById('shareBtn');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const endBtn = document.getElementById('endBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const exportWinningBtn = document.getElementById('exportWinningBtn');
const datesSummary = document.getElementById('datesSummary');

/* ---------- local state ---------- */
let sellerEntry = null; // { code, sellerId } from entryCodes
let currentSaleId = null;
let currentSale = null;
let lots = []; // local copy of lots

entryCheckBtn.addEventListener('click', async () => {
  const code = entryCodeInput.value.trim();
  if(!code){ entryMsg.textContent='Please enter a code.'; return; }
  entryMsg.textContent='Checking...';
  // Look up entryCodes collection
  const snap = await db.collection('entryCodes').where('code','==',code).limit(1).get();
  if(snap.empty){
    entryMsg.textContent='Invalid entry number.';
    return;
  }
  const doc = snap.docs[0];
  sellerEntry = { id: doc.id, ...doc.data() };
  entryMsg.textContent = `Welcome — seller id: ${sellerEntry.sellerId}`;
  showBuilder();
});

function showBuilder(){
  entryCard.style.display='none';
  builder.style.display='block';
  // if seller already has a sale ID assigned, load it
  loadSellerSale();
}

async function loadSellerSale(){
  // attempt to find a sale doc for this seller
  const q = await db.collection('sales').where('sellerId','==',sellerEntry.sellerId).limit(1).get();
  if(!q.empty){
    const sdoc = q.docs[0];
    currentSaleId = sdoc.id;
    currentSale = sdoc.data();
    loadSaleIntoUI();
    listenToLots();
  } else {
    // no sale yet
    currentSaleId = null;
    currentSale = null;
    buildLotsEditor([]);
  }
}

function loadSaleIntoUI(){
  businessName.value = currentSale.businessName || '';
  saleName.value = currentSale.saleName || '';
  saleDesc.value = currentSale.description || '';
  if(currentSale.logoUrl){
    previewLogo.src = currentSale.logoUrl;
    previewLogo.style.display='block';
  }
  previewTitle.textContent = `${currentSale.businessName || ''} · ${currentSale.saleName || ''}`;
  previewSub.textContent = currentSale.description || '';
  liveUrl.textContent = window.location.origin + '/biddingform/live.html?saleId=' + currentSaleId;
  datesSummary.textContent = `${formatSaleDate(currentSale.start)} thru ${formatSaleDate(currentSale.end)}`;
  // reflect global bid toggle
  globalBidToggle.value = currentSale.useGlobal ? 'yes' : 'no';
  globalStart.value = currentSale.globalStart || '';
  globalIncrement.value = currentSale.globalIncrement || 0;
  startDT.value = toInputDateTimeLocal(currentSale.start);
  endDT.value = toInputDateTimeLocal(currentSale.end);
  tzSelect.value = currentSale.timezone || 'UTC';
}

function toInputDateTimeLocal(ts){
  try{
    const d = new Date(ts);
    const tzOffset = d.getTimezoneOffset() * 60000;
    const local = new Date(d.getTime() - tzOffset);
    return local.toISOString().slice(0,16);
  }catch(e){ return ''; }
}
function formatSaleDate(ts){
  const d = new Date(ts);
  return (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear()+' at '+d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

/* ---------- Create Sale ---------- */
createSaleBtn.addEventListener('click', async () => {
  if(!sellerEntry) return alert('You must enter your entry code first.');
  // upload logo if present
  let logoUrl = '';
  if(logoFile.files && logoFile.files[0]){
    const file = logoFile.files[0];
    const ref = storage.ref().child(`logos/${sellerEntry.sellerId}_${Date.now()}_${file.name}`);
    await ref.put(file);
    logoUrl = await ref.getDownloadURL();
  }
  const saleDoc = {
    sellerId: sellerEntry.sellerId,
    businessName: businessName.value,
    saleName: saleName.value,
    description: saleDesc.value,
    logoUrl,
    useGlobal: globalBidToggle.value === 'yes',
    globalStart: Number(globalStart.value) || 0,
    globalIncrement: Number(globalIncrement.value) || 1,
    start: new Date(startDT.value).toISOString(),
    end: new Date(endDT.value).toISOString(),
    timezone: tzSelect.value,
    status: 'draft', // draft | live | paused | ended
    createdAt: new Date().toISOString()
  };
  const res = await db.collection('sales').add(saleDoc);
  currentSaleId = res.id;
  currentSale = saleDoc;
  // create lots
  const n = Math.max(1, Number(numLots.value || 1));
  const batch = db.batch();
  for(let i=1;i<=n;i++){
    const lotRef = db.collection('sales').doc(currentSaleId).collection('lots').doc();
    const lot = {
      lotNumber: i,
      earNotch: `Lot ${i}`,
      photoUrl: '',
      pedigree: '',
      breed: '',
      startingBid: saleDoc.useGlobal ? saleDoc.globalStart : 0,
      increment: saleDoc.useGlobal ? saleDoc.globalIncrement : 0,
      currentBid: null,
      currentBidder: null,
      createdAt: new Date().toISOString()
    };
    batch.set(lotRef, lot);
  }
  await batch.commit();
  alert('Sale created! You can now edit lots and publish.');
  loadSaleIntoUI();
  listenToLots();
});

saveSaleBtn.addEventListener('click', async () => {
  if(!currentSaleId) return alert('No sale to save.');
  // upload logo if present
  let logoUrl = currentSale.logoUrl || '';
  if(logoFile.files && logoFile.files[0]){
    const file = logoFile.files[0];
    const ref = storage.ref().child(`logos/${sellerEntry.sellerId}_${Date.now()}_${file.name}`);
    await ref.put(file);
    logoUrl = await ref.getDownloadURL();
  }
  const data = {
    businessName: businessName.value,
    saleName: saleName.value,
    description: saleDesc.value,
    logoUrl,
    useGlobal: globalBidToggle.value === 'yes',
    globalStart: Number(globalStart.value) || 0,
    globalIncrement: Number(globalIncrement.value) || 1,
    start: new Date(startDT.value).toISOString(),
    end: new Date(endDT.value).toISOString(),
    timezone: tzSelect.value,
    updatedAt: new Date().toISOString()
  };
  await db.collection('sales').doc(currentSaleId).update(data);
  alert('Saved.');
  currentSale = {...currentSale, ...data};
  loadSaleIntoUI();
});

function listenToLots(){
  if(!currentSaleId) return;
  db.collection('sales').doc(currentSaleId).collection('lots').orderBy('lotNumber').onSnapshot(snap=>{
    lots = [];
    snap.forEach(d=>lots.push({ id: d.id, ...d.data() }));
    renderLotsPreview();
    buildLotsEditor(lots);
  });
}

/* ---------- UI for lots (preview and editor) ---------- */
function renderLotsPreview(){
  lotsContainer.innerHTML = '';
  if(lots.length === 0){ lotsContainer.innerHTML='<div class="small-muted">No lots yet</div>'; return; }
  const row = document.createElement('div');
  row.className='lot-grid';
  lots.forEach(l=>{
    const card = document.createElement('div');
    card.className='lot-card';
    card.innerHTML = `
      <div style="font-weight:700">Lot ${l.lotNumber} | ${escapeHtml(l.earNotch || '')}</div>
      <img src="${l.photoUrl || ''}" class="lot-photo" onerror="this.style.display='none'"/>
      <div class="meta">${escapeHtml(l.pedigree || '')} · ${escapeHtml(l.breed || '')}</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${l.currentBid ? ('$'+l.currentBid) : '<span class=small-muted>Starting Bid</span>'}</div>
        <div class="small-muted">Bidder: ${l.currentBidder || '-'}</div>
      </div>
    `;
    row.appendChild(card);
  });
  lotsContainer.appendChild(row);
}

function buildLotsEditor(lotsArr){
  lotsBuilder.innerHTML = '';
  if(!currentSaleId) return;
  lotsArr.forEach((lot, idx)=>{
    const div = document.createElement('div');
    div.className='card';
    div.style.marginTop='12px';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Lot ${lot.lotNumber}</div>
        <div class="small-muted">id: ${lot.id}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 120px;gap:8px;margin-top:8px">
        <div>
          <label class="small">Ear Notch / Title</label>
          <input data-lot="${lot.id}" data-field="earNotch" class="input lot-field" value="${escapeHtml(lot.earNotch||'')}" />
        </div>
        <div>
          <label class="small">Upload Photo</label>
          <input data-lot="${lot.id}" data-field="photo" type="file" accept="image/*" class="input lot-photo-file" />
        </div>

        <div>
          <label class="small">Pedigree</label>
          <input data-lot="${lot.id}" data-field="pedigree" class="input lot-field" value="${escapeHtml(lot.pedigree||'')}" />
        </div>
        <div>
          <label class="small">Breed</label>
          <input data-lot="${lot.id}" data-field="breed" class="input lot-field" value="${escapeHtml(lot.breed||'')}" />
        </div>

        <div>
          <label class="small">Starting Bid ($)</label>
          <input data-lot="${lot.id}" data-field="startingBid" type="number" class="input lot-field" value="${lot.startingBid||0}" ${currentSale && currentSale.useGlobal ? 'disabled' : ''} />
        </div>
        <div>
          <label class="small">Increment ($)</label>
          <input data-lot="${lot.id}" data-field="increment" type="number" class="input lot-field" value="${lot.increment||0}" ${currentSale && currentSale.useGlobal ? 'disabled' : ''} />
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn btn-ghost save-lot" data-id="${lot.id}">Save Lot</button>
        <button class="btn btn-ghost delete-lot" data-id="${lot.id}">Delete</button>
      </div>
    `;
    lotsBuilder.appendChild(div);
  });

  // wire up events
  document.querySelectorAll('.save-lot').forEach(b=>{
    b.onclick = async (e)=>{
      const id = e.target.dataset.id;
      const container = e.target.closest('.card');
      const inputs = container.querySelectorAll('.lot-field');
      const data = {};
      inputs.forEach(inp=>{
        const field = inp.dataset.field;
        data[field] = inp.type==='number' ? Number(inp.value) : inp.value;
      });
      // check photo file input
      const photoInput = container.querySelector('.lot-photo-file');
      if(photoInput && photoInput.files && photoInput.files[0]){
        const file = photoInput.files[0];
        const ref = storage.ref().child(`lots/${currentSaleId}_${id}_${Date.now()}_${file.name}`);
        await ref.put(file);
        data.photoUrl = await ref.getDownloadURL();
      }
      await db.collection('sales').doc(currentSaleId).collection('lots').doc(id).update(data);
      alert('lot saved');
    }
  });
  document.querySelectorAll('.delete-lot').forEach(b=>{
    b.onclick = async (e)=>{
      if(!confirm('Delete this lot?')) return;
      const id = e.target.dataset.id;
      await db.collection('sales').doc(currentSaleId).collection('lots').doc(id).delete();
    }
  });
}

/* ---------- share / start / pause / end / exports ---------- */
shareBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale created yet.');
  const url = window.location.origin + '/biddingform/live.html?saleId=' + currentSaleId;
  try{
    await navigator.clipboard.writeText(url);
    alert('Live URL copied to clipboard:\n' + url);
  }catch(e){
    prompt('Copy this URL', url);
  }
});
startBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale.');
  await db.collection('sales').doc(currentSaleId).update({ status: 'live', startedAt: new Date().toISOString() });
  alert('Sale started (live).');
});
pauseBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale.');
  await db.collection('sales').doc(currentSaleId).update({ status: 'paused' });
  alert('Sale paused.');
});
endBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale.');
  await db.collection('sales').doc(currentSaleId).update({ status: 'ended', endedAt: new Date().toISOString() });
  alert('Sale ended.');
});
exportAllBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale.');
  const bidsSnap = await db.collection('sales').doc(currentSaleId).collection('bids').orderBy('createdAt').get();
  const rows = [['lotId','lotNumber','bidAmount','bidderNumber','bidderName','createdAt']];
  bidsSnap.forEach(d=>{
    const b = d.data();
    rows.push([b.lotId||'', b.lotNumber||'', b.amount||'', b.bidderNumber||'', b.bidderName||'', b.createdAt||'']);
  });
  downloadCSV(rows, `all_bids_${currentSaleId}.csv`);
});
exportWinningBtn.addEventListener('click', async ()=>{
  if(!currentSaleId) return alert('No sale.');
  const lotsSnap = await db.collection('sales').doc(currentSaleId).collection('lots').orderBy('lotNumber').get();
  const rows = [['lotNumber','earNotch','winningBid','winningBidder']];
  lotsSnap.forEach(d=>{
    const l = d.data();
    rows.push([l.lotNumber||'', l.earNotch||'', l.currentBid||'', l.currentBidder||'']);
  });
  downloadCSV(rows, `winning_bids_${currentSaleId}.csv`);
});

function downloadCSV(rows, filename){
  const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ---------- helper ---------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
