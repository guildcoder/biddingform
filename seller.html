<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seller Portal - Caprock Livestock</title>
<style>
body { font-family:'Oswald', sans-serif; background:#0D1B2A; color:#F7F2EC; margin:0; padding:0; }
header { padding:20px; text-align:center; background:#8A1E1E; font-size:2rem; }
.container { max-width:800px; margin:auto; padding:20px; }
input, select, button { display:block; margin-bottom:15px; padding:10px; border-radius:10px; border:none; width:100%; }
button { background:#8A1E1E; color:#F7F2EC; cursor:pointer; }
button:hover { background:#B22222; }
#lotForm { display:none; }
.lot-preview img { width:100%; max-width:300px; border-radius:10px; }
#loginStatus { margin-bottom:15px; color:#FFCCCC; }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
<header>Seller Portal Login</header>
<div class="container">
    <p id="loginStatus">Enter your credentials to access the portal.</p>
    <input type="text" id="sellerName" placeholder="Your Name">
    <input type="text" id="sellerCode" placeholder="Authentication Code">
    <button id="unlockBtn">Login</button>

    <div id="lotForm">
        <h2>Add New Lot</h2>
        <input type="text" id="lotTitle" placeholder="Lot # | Ear Notch">
        <input type="text" id="pedigree" placeholder="Pedigree">
        <input type="text" id="breed" placeholder="Breed">
        <input type="number" id="startPrice" placeholder="Starting Bid Price">
        <input type="number" id="bidIncrement" placeholder="Bid Increment ($)">
        <input type="file" id="lotImage">
        <div class="lot-preview" id="lotPreview"></div>
        <button id="addLotBtn">Add Lot</button>
        <p id="statusMsg"></p>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCquC_ZsPf59yGnlFLzK8Du1mgibvKOK_M",
    authDomain: "biddingapp-a6d8e.firebaseapp.com",
    projectId: "biddingapp-a6d8e",
    storageBucket: "biddingapp-a6d8e.firebasestorage.app",
    messagingSenderId: "870014358891",
    appId: "1:870014358891:web:b74cf577dfd38eff46e82e",
    measurementId: "G-0QWG9DQCLG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// Login system
async function unlockSeller() {
    const name = document.getElementById("sellerName").value.trim();
    const code = document.getElementById("sellerCode").value.trim();
    const infoBox = document.getElementById("loginStatus");

    try {
        const response = await fetch("./authorized.txt");
        if (!response.ok) {
            infoBox.textContent = "Error loading authorization file.";
            return;
        }

        const text = await response.text();
        const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);

        let authenticated = false;

        for (let i = 0; i < lines.length; i += 3) {
            const userName = lines[i];
            const expiration = lines[i + 1];
            const accessCode = lines[i + 2];

            if (name === userName && code === accessCode) {
                const today = new Date().toISOString().split("T")[0];
                if (today <= expiration) {
                    authenticated = true;
                    break;
                } else {
                    infoBox.textContent = "Your access has expired.";
                    return;
                }
            }
        }

        if (authenticated) {
            infoBox.textContent = `Welcome, ${name}!`;
            document.getElementById("lotForm").style.display = "block";
        } else {
            infoBox.textContent = "Invalid credentials.";
        }
    } catch (error) {
        infoBox.textContent = "Login system error.";
        console.error(error);
    }
}

document.getElementById("unlockBtn").addEventListener("click", unlockSeller);

// Lot image preview
const lotImageInput = document.getElementById("lotImage");
const lotPreview = document.getElementById("lotPreview");
lotImageInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        lotPreview.innerHTML = `<img src="${reader.result}" alt="Lot Image">`;
    };
    reader.readAsDataURL(file);
});

// Add Lot to Firestore + Storage
document.getElementById("addLotBtn").addEventListener("click", async () => {
    const title = document.getElementById("lotTitle").value.trim();
    const pedigree = document.getElementById("pedigree").value.trim();
    const breed = document.getElementById("breed").value.trim();
    const startPrice = Number(document.getElementById("startPrice").value);
    const bidIncrement = Number(document.getElementById("bidIncrement").value);
    const file = lotImageInput.files[0];
    const statusMsg = document.getElementById("statusMsg");

    if (!title || !startPrice || !bidIncrement) {
        statusMsg.textContent = "Please fill all required fields.";
        return;
    }

    try {
        let imageURL = "";
        if (file) {
            const storageRef = storage.ref().child(`lots/${Date.now()}_${file.name}`);
            await storageRef.put(file);
            imageURL = await storageRef.getDownloadURL();
        }

        await db.collection("sales").doc("demoSale").collection("lots").add({
            title,
            pedigree,
            breed,
            startPrice,
            bidIncrement,
            currentBid: null,
            currentBidder: null,
            imageURL: imageURL || ""
        });

        statusMsg.textContent = "Lot added successfully!";
        document.getElementById("lotTitle").value = "";
        document.getElementById("pedigree").value = "";
        document.getElementById("breed").value = "";
        document.getElementById("startPrice").value = "";
        document.getElementById("bidIncrement").value = "";
        lotImageInput.value = "";
        lotPreview.innerHTML = "";
    } catch (err) {
        console.error(err);
        statusMsg.textContent = "Error adding lot.";
    }
});
</script>
</body>
</html>
