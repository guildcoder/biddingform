<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Caprock — Live Bidding</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f3f2ef; --accent:#6b0f18; --navy:#041029; --card:#fff; --muted:#7b7b7b;
}
body{margin:0;font-family:Inter,system-ui; background:var(--bg); color:var(--navy)}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.title{font-family:Playfair Display,serif;font-size:22px}
.small-muted{font-size:13px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px}
.card{background:var(--card);border-radius:10px;padding:12px;border:1px solid #eee;box-shadow:0 6px 18px rgba(4,16,41,0.04)}
.lot-photo{width:100%;height:180px;border-radius:8px;object-fit:cover;background:#fafafa}
.top-actions{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff}
.modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999}
.modal{background:#fff;border-radius:10px;padding:14px;max-width:480px;width:92%}
.input{padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%;margin-top:8px}
.lightbox-img{max-width:90vw;max-height:80vh;border-radius:10px}
.small{font-size:13px;color:var(--muted)}
.badge{background:#f7f7f7;padding:6px 8px;border-radius:6px;font-family:monospace}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="header">
    <div>
      <div class="title" id="titleText">Caprock Live Bidding</div>
      <div class="small-muted" id="subtitle">—</div>
    </div>
    <div class="top-actions">
      <div id="saleTimes" class="small-muted"></div>
      <button id="getNumberBtn" class="btn btn-primary">Get Bidding Number</button>
    </div>
  </div>

  <div id="lotsGrid" class="grid"></div>
</div>

<!-- modals -->
<div id="modalRoot" style="display:none"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCquC_ZsPf59yGnlFLzK8Du1mgibvKOK_M",
  authDomain: "biddingapp-a6d8e.firebaseapp.com",
  projectId: "biddingapp-a6d8e",
  storageBucket: "biddingapp-a6d8e.firebasestorage.app",
  messagingSenderId: "870014358891",
  appId: "1:870014358891:web:b74cf577dfd38eff46e82e",
  measurementId: "G-0QWG9DQCLG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const saleId = urlParams.get('saleId');

const titleText = document.getElementById('titleText');
const subtitle = document.getElementById('subtitle');
const lotsGrid = document.getElementById('lotsGrid');
const saleTimes = document.getElementById('saleTimes');
const modalRoot = document.getElementById('modalRoot');

let saleDoc = null;
let bidderSession = null; // { bidderNumber, name, phone, email }

async function init(){
  if(!saleId) return alert('No saleId provided in URL.');
  const sdoc = await db.collection('sales').doc(saleId).get();
  if(!sdoc.exists) return alert('Sale not found.');
  saleDoc = sdoc.data();
  titleText.textContent = `${saleDoc.businessName || ''} · ${saleDoc.saleName || ''}`;
  subtitle.textContent = saleDoc.description || '';
  saleTimes.textContent = `Sale: ${formatSaleDate(saleDoc.start)} → ${formatSaleDate(saleDoc.end)} ${saleDoc.timezone||''}`;

  // load lots and listen for updates
  db.collection('sales').doc(saleId).collection('lots').orderBy('lotNumber').onSnapshot(snap=>{
    lotsGrid.innerHTML='';
    snap.forEach(d=>{
      const l = { id: d.id, ...d.data() };
      lotsGrid.appendChild(renderLotCard(l));
    });
  });

  // auto-change status if based on start/end
  setInterval(checkAutoStartEnd, 15000);
}
function formatSaleDate(ts){ return new Date(ts).toLocaleString(); }

function renderLotCard(l){
  const card = document.createElement('div'); card.className='card';
  const currentBidText = l.currentBid ? '$'+l.currentBid : '<span class="small">Starting Bid</span>';
  const bidderText = l.currentBidder ? l.currentBidder : '-';
  card.innerHTML = `
    <div style="font-weight:700">Lot ${l.lotNumber} | ${escapeHtml(l.earNotch||'')}</div>
    <img src="${l.photoUrl||''}" class="lot-photo" onclick="openLightbox('${l.photoUrl||''}')" onerror="this.style.display='none'"/>
    <div class="small">${escapeHtml(l.pedigree||'')} · ${escapeHtml(l.breed||'')}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div style="font-weight:700">${currentBidText}</div>
      <div class="small-muted">Bidder: <span class="badge">${bidderText}</span></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-primary bid-btn" data-id="${l.id}" data-lotnum="${l.lotNumber}" data-start="${l.startingBid||0}" data-incr="${l.increment||0}">Bid on me!</button>
    </div>
  `;
  // attach click
  setTimeout(()=>{ card.querySelector('.bid-btn').onclick = ()=>openBidModal(l); },0);
  return card;
}

function openLightbox(url){
  if(!url) return;
  const backdrop = document.createElement('div');
  backdrop.className='modal-backdrop';
  backdrop.innerHTML = `<img src="${url}" class="lightbox-img" />`;
  backdrop.onclick = ()=>backdrop.remove();
  document.body.appendChild(backdrop);
}

function openBidModal(lot){
  if(!saleDoc) return;
  // ensure sale status is live
  db.collection('sales').doc(saleId).get().then(snap=>{
    const sale = snap.data();
    if(!sale) return alert('Sale not available');
    if(sale.status !== 'live'){
      return alert('Sale is not open for bidding.');
    }
    showBidModal(lot);
  });
}

function showBidModal(lot){
  const modalHtml = `
    <div class="modal-backdrop" id="bidBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div style="font-weight:700">Lot ${lot.lotNumber} | ${escapeHtml(lot.earNotch||'')}</div>
        <img src="${lot.photoUrl||''}" class="lot-photo" style="margin-top:8px" onerror="this.style.display='none'"/>
        <div class="small" style="margin-top:6px">${escapeHtml(lot.pedigree||'')} · ${escapeHtml(lot.breed||'')}</div>

        <div style="margin-top:8px">
          <div class="small">Current: ${lot.currentBid ? '$'+lot.currentBid : 'Starting: $'+(lot.startingBid||0)}</div>
          <div class="small">Increment: $${lot.increment||saleDoc.globalIncrement||0}</div>
        </div>

        <div style="margin-top:8px">
          <label class="small">Your last 4 digits of phone</label>
          <input id="phone4" class="input" placeholder="e.g. 1234" maxlength="4"/>
          <label class="small">Your bidding number</label>
          <input id="bidNumberInput" class="input" placeholder="If you have one, enter it — otherwise click Get Bidding Number"/>
          <label class="small">Bid Amount (must follow increments)</label>
          <input id="bidAmountInput" class="input" type="number" />
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="modalCancel" class="btn">Cancel</button>
          <button id="modalSubmit" class="btn btn-primary">Place Bid</button>
        </div>
      </div>
    </div>
  `;
  modalRoot.innerHTML = modalHtml;
  modalRoot.style.display = 'block';
  document.getElementById('modalCancel').onclick = ()=> { modalRoot.style.display='none'; modalRoot.innerHTML=''; };
  document.getElementById('bidBackdrop').onclick = ()=> { modalRoot.style.display='none'; modalRoot.innerHTML=''; };

  document.getElementById('modalSubmit').onclick = async ()=>{
    const phone4 = document.getElementById('phone4').value.trim();
    const bidderNumber = document.getElementById('bidNumberInput').value.trim();
    const amount = Number(document.getElementById('bidAmountInput').value || 0);
    if(!phone4 || phone4.length !== 4) return alert('Enter last 4 digits of phone.');
    if(!bidderNumber) return alert('Enter bidding number (Get one if you do not have one).');
    if(!amount || amount <= 0) return alert('Enter a valid bid amount.');

    // Validate increment
    const increment = lot.increment || saleDoc.globalIncrement || 1;
    const current = lot.currentBid || lot.startingBid || saleDoc.globalStart || 0;
    const minAllowed = (lot.currentBid ? current + increment : Math.max(current, lot.startingBid || 0));
    if(amount < minAllowed) return alert('Bid must be at least $' + minAllowed);
    // ensure (amount - base) is multiple of increment
    if(((amount - (lot.currentBid || lot.startingBid || saleDoc.globalStart || 0)) % increment) !== 0) {
      return alert('Bid must follow the increment of $' + increment);
    }

    // place bid: add bid doc and update lot atomically using transaction
    const bidData = {
      saleId,
      lotId: lot.id,
      lotNumber: lot.lotNumber,
      amount,
      bidderNumber,
      bidderPhone4: phone4,
      bidderName: null,
      createdAt: new Date().toISOString()
    };
    const lotRef = db.collection('sales').doc(saleId).collection('lots').doc(lot.id);
    const bidsRef = db.collection('sales').doc(saleId).collection('bids').doc();
    try{
      await db.runTransaction(async (tx)=>{
        const ldoc = await tx.get(lotRef);
        const ldata = ldoc.data();
        const currentNow = ldata.currentBid || ldata.startingBid || saleDoc.globalStart || 0;
        if(amount <= currentNow) throw "Your bid is not high enough (someone beat that already).";
        tx.set(bidsRef, { ...bidData, createdAt: new Date().toISOString() });
        tx.update(lotRef, { currentBid: amount, currentBidder: bidderNumber });
      });
      alert('Bid placed!');
      modalRoot.style.display='none'; modalRoot.innerHTML='';
    }catch(err){
      alert('Failed to place bid: ' + err);
    }
  };
}

document.getElementById('getNumberBtn').onclick = ()=>openGetNumberModal();

function openGetNumberModal(){
  const html = `
    <div class="modal-backdrop" id="numBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div style="font-weight:700">Get Bidding Number</div>
        <div class="small">Enter name, phone, and email. We'll give you a unique 5-digit bidding number for this sale.</div>
        <input id="bnName" class="input" placeholder="Your name" />
        <input id="bnPhone" class="input" placeholder="Phone (best contact)" />
        <input id="bnEmail" class="input" placeholder="Email (optional)" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="bnCancel" class="btn">Cancel</button>
          <button id="bnSubmit" class="btn btn-primary">Get Number</button>
        </div>
      </div>
    </div>
  `;
  modalRoot.innerHTML = html; modalRoot.style.display='block';
  document.getElementById('bnCancel').onclick = ()=>{ modalRoot.style.display='none'; modalRoot.innerHTML=''; };
  document.getElementById('bnSubmit').onclick = async ()=>{
    const name = document.getElementById('bnName').value.trim();
    const phone = document.getElementById('bnPhone').value.trim();
    const email = document.getElementById('bnEmail').value.trim();
    if(!name || !phone) return alert('Name and phone required');
    // generate unique 5-digit number (simple loop)
    let number = '';
    for(let i=0;i<6;i++){
      number = Math.floor(10000 + Math.random()*90000).toString();
      const q = await db.collection('sales').doc(saleId).collection('bidders').where('biddingNumber','==',number).get();
      if(q.empty) break;
      number = '';
    }
    if(!number) return alert('Failed to generate unique number, try again.');
    await db.collection('sales').doc(saleId).collection('bidders').add({
      name, phone, email, biddingNumber: number, createdAt: new Date().toISOString()
    });
    // show the number
    alert('Your bidding number: ' + number + '\nKeep it for all bids.');
    modalRoot.style.display='none'; modalRoot.innerHTML='';
  };
}

/* auto start/end based on times - updates sale.status locally (the seller also has start/pause/end buttons) */
async function checkAutoStartEnd(){
  if(!saleDoc) return;
  const now = new Date();
  const start = new Date(saleDoc.start);
  const end = new Date(saleDoc.end);
  const ref = db.collection('sales').doc(saleId);
  if(now >= start && now < end && saleDoc.status !== 'live'){
    await ref.update({ status: 'live', startedAt: new Date().toISOString() });
    saleDoc.status = 'live';
  } else if(now >= end && saleDoc.status !== 'ended'){
    await ref.update({ status: 'ended', endedAt: new Date().toISOString() });
    saleDoc.status = 'ended';
  }
}

/* small helpers */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

init();
</script>
</body>
</html>
